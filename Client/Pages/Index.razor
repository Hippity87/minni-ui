@page "/"
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<div class="page-wrap mx-auto">
  <div class="hero-wrap text-center">
  <img src="img/minni-luokittelija.png"
       alt="Minni-luokittelija"
       class="hero-img img-fluid"
       onerror="this.style.display='none'; document.getElementById('title-fallback').style.display='block';" />
  <h2 id="title-fallback" style="display:none;">Minni-luokittelija</h2>
</div>

  <p class="text-muted lead-sm">
    Tässä projektissa tunnistetaan Minni-koira Azure Custom Visionin avulla.
    Käyttöliittymä (Blazor WASM) lähettää kuvan Azure Functions -rajapintaan
    (<code>/api/classify</code> tai <code>/api/classify-image</code>), joka kutsuu
    Custom Visionin Prediction-palvelua ja soveltaa 0.80-thresholdin ennen tuloksen palautusta.
  </p>

  @if (error is not null)
  {
    <div class="alert alert-danger" role="alert">@error</div>
  }

  <div class="mb-3">
    <label class="form-label fw-semibold">Valitse kuva (JPEG/PNG/WebP)</label>
    <InputFile OnChange="OnFileSelected" accept="image/*" class="form-control" />
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">…tai anna kuvan URL</label>
    <div class="input-group">
      <input class="form-control text-break" @bind="imageUrl" placeholder="https://example.com/image.jpg" />
      <button class="btn btn-primary" @onclick="ClassifyUrl" disabled="@isBusy">Luokittele URL</button>
    </div>
  </div>

  @if (previewDataUrl is not null)
  {
    <div class="mb-3 text-center">
      <img src="@previewDataUrl" class="img-fluid rounded shadow-sm preview-img" />
    </div>
  }

  <div class="d-grid gap-2 d-sm-flex">
    <button class="btn btn-success" @onclick="ClassifyFile" disabled="@(!hasFile || isBusy)">
      Luokittele valittu tiedosto
    </button>
    <button class="btn btn-outline-secondary" @onclick="ClearAll" disabled="@isBusy">Tyhjennä</button>
  </div>

  @if (result is not null)
  {
    <hr class="my-4" />
    <h5 class="mb-2">Tulos</h5>
    <p class="mb-2">
      <span class="badge bg-primary me-2">@result.decision</span>
      <span class="text-muted">Top: @result.topTag (@Percent(result.topProb)), threshold @result.threshold</span>
    </p>
    <ul class="mb-0">
      @foreach (var p in result.predictions)
      {
        <li>@p.tag: @Percent(p.prob)</li>
      }
    </ul>
  }
</div>

@code {
  string? imageUrl;
  IBrowserFile? file;
  string? previewDataUrl;
  bool hasFile => file is not null;
  bool isBusy;
  string? error;

  PredictionResult? result;

  record Prediction(string tag, double prob);
  record PredictionResult(bool ok, double threshold, string decision, string topTag, double topProb, List<Prediction> predictions);

  async Task OnFileSelected(InputFileChangeEventArgs e)
  {
    error = null; result = null;
    file = e.File;

    using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
    using var ms = new MemoryStream();
    await stream.CopyToAsync(ms);
    var base64 = Convert.ToBase64String(ms.ToArray());
    var mime = file.ContentType ?? "image/jpeg";
    previewDataUrl = $"data:{mime};base64,{base64}";
  }

  async Task ClassifyFile()
  {
    if (file is null) return;
    try
    {
      isBusy = true; error = null; result = null;

      using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
      using var content = new StreamContent(stream);
      content.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream");

      var resp = await Http.PostAsync("/api/classify-image", content);
      var json = await resp.Content.ReadAsStringAsync();
      if (!resp.IsSuccessStatusCode)
      {
        error = $"Virhe: {resp.StatusCode} {json}";
        return;
      }

      result = System.Text.Json.JsonSerializer.Deserialize<PredictionResult>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
    }
    catch (Exception ex)
    {
      error = ex.Message;
    }
    finally
    {
      isBusy = false;
      StateHasChanged();
    }
  }

  async Task ClassifyUrl()
  {
    if (string.IsNullOrWhiteSpace(imageUrl)) { error = "Anna kuvan URL"; return; }
    try
    {
      isBusy = true; error = null; result = null;

      var payload = new { imageUrl };
      var content = new StringContent(System.Text.Json.JsonSerializer.Serialize(payload), System.Text.Encoding.UTF8, "application/json");
      var resp = await Http.PostAsync("/api/classify", content);
      var json = await resp.Content.ReadAsStringAsync();
      if (!resp.IsSuccessStatusCode)
      {
        error = $"Virhe: {resp.StatusCode} {json}";
        return;
      }
      result = System.Text.Json.JsonSerializer.Deserialize<PredictionResult>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
      previewDataUrl = imageUrl;
    }
    catch (Exception ex)
    {
      error = ex.Message;
    }
    finally
    {
      isBusy = false;
      StateHasChanged();
    }
  }

  void ClearAll()
  {
    imageUrl = null;
    file = null;
    previewDataUrl = null;
    result = null;
    error = null;
  }

  static string Percent(double p) => $"{Math.Round(p * 100, 1)}%";
}

